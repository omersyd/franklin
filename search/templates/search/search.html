{% extends 'base.html' %}

{% block extra_css %}
<style>
    .search-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .search-container {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
        margin-bottom: 2rem;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        justify-content: center;
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-label {
        font-weight: 500;
        color: #333;
        font-size: 0.9rem;
    }

    .filter-select, .filter-input {
        padding: 0.7rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 120px;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 0.7rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .autocomplete-item:hover, .autocomplete-item.highlighted {
        background-color: #f8f9fa;
    }

    .results-section {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .results-count {
        font-size: 1.1rem;
        font-weight: 500;
        color: #333;
    }

    .app-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
        background: white;
        cursor: pointer;
    }

    .app-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #667eea;
        transform: translateY(-2px);
    }

    .app-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        cursor: pointer;
    }

    .app-name:hover {
        color: #667eea;
    }

    .app-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #666;
    }

    .app-meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .similarity-score {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #666;
        font-size: 1.1rem;
    }

    .no-results {
        text-align: center;
        padding: 3rem;
        color: #666;
    }

    .no-results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

        .load-more-btn {
        display: block;
        margin: 2rem auto 0;
        padding: 0.8rem 2rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .load-more-btn:hover {
        background: #5a6fd8;
    }

    .load-more-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Pagination Controls */
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .page-btn {
        padding: 0.5rem 1rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-info {
        margin: 0 1rem;
        font-size: 0.9rem;
        color: #666;
    }

    /* Rating Input Styles */
    .rating-input {
        display: flex;
        gap: 0.5rem;
        margin: 1rem 0;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }

    .rating-input input[type="radio"] {
        display: none;
    }

    .rating-input label {
        font-size: 1.5rem;
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.2s;
    }

    .rating-input input[type="radio"]:checked ~ label,
    .rating-input label:hover,
    .rating-input label:hover ~ label {
        color: #fbbf24;
    }

    @media (max-width: 768px) {
        .filters {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            width: 100%;
        }

        .app-meta {
            flex-direction: column;
            gap: 0.5rem;
        }

        .search-header {
            padding: 1.5rem;
        }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
    }

    .modal-title {
        margin: 0;
        color: white;
        font-size: 1.5rem;
    }

    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: white;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .close:hover {
        background-color: rgba(255,255,255,0.2);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .app-details {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .app-details h3 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.3rem;
    }

    .app-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .app-info-item {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .app-info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
    }

    .app-info-value {
        font-size: 1rem;
        color: #333;
    }

    .reviews-container {
        max-height: 400px;
        overflow-y: auto;
    }

    .review-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.2rem;
        margin-bottom: 1rem;
        transition: box-shadow 0.2s;
    }

    .review-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
    }

    .review-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #f59e0b;
    }

    .review-date {
        color: #666;
        font-size: 0.9rem;
    }

    .review-text {
        line-height: 1.6;
        color: #333;
        margin-bottom: 0.8rem;
    }

    .review-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        color: #666;
    }

    .sentiment-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .sentiment-positive {
        background: #d1fae5;
        color: #065f46;
    }

    .sentiment-negative {
        background: #fecaca;
        color: #991b1b;
    }

    .sentiment-neutral {
        background: #fef3c7;
        color: #92400e;
    }

    .reviews-loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-header">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: #333;">üîç Search Apps</h1>
    <p style="color: #666; font-size: 1.1rem;">
        Find your perfect app from thousands of Google Play Store applications
    </p>
</div>

<div class="search-container">
    <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="{{ placeholder_text }}"
        autocomplete="off"
    >
    <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
</div>

<div class="filters">
    <div class="filter-group">
        <label class="filter-label">Category</label>
        <select id="categoryFilter" class="filter-select">
            <option value="">All Categories</option>
        </select>
    </div>
    <div class="filter-group">
        <label class="filter-label">Min Rating</label>
        <input type="number" id="ratingFilter" class="filter-input" placeholder="e.g. 4.0" min="0" max="5" step="0.1">
    </div>
    <div class="filter-group">
        <label class="filter-label">Results per page</label>
        <select id="limitFilter" class="filter-select">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
        </select>
    </div>
</div>

<div id="resultsSection" class="results-section" style="display: none;">
    <div class="results-header">
        <div class="results-count" id="resultsCount">0 results found</div>
    </div>
    <div id="searchResults"></div>
    <button id="loadMoreBtn" class="load-more-btn" style="display: none;">Load More</button>
</div>

<div id="noResults" class="no-results" style="display: none;">
    <div class="no-results-icon">üîç</div>
    <h3>No apps found</h3>
    <p>Try adjusting your search terms or filters</p>
</div>

<div id="loading" class="loading" style="display: none;">
    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
    <div>Searching apps...</div>
</div>

<!-- App Reviews Modal -->
<div id="reviewsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalAppName">App Reviews</h2>
            <button class="close" onclick="closeReviewsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="appDetails" class="app-details">
                <!-- App details will be populated here -->
            </div>
            <div class="app-actions" style="margin: 1rem 0; text-align: center;">
                <button id="writeReviewBtn" class="btn btn-primary" onclick="openReviewForm()" style="background: #667eea; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: background 0.3s;">
                    Write Review
                </button>
            </div>
            <div id="reviewsContainer" class="reviews-container">
                <!-- Reviews will be populated here -->
            </div>
            <div id="reviewsLoading" class="reviews-loading" style="display: none;">
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                    <div>Loading reviews...</div>
                </div>
            </div>
            <div id="noReviews" style="display: none; text-align: center; padding: 2rem; color: #666;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                <div>No reviews available for this app</div>
            </div>
            <div id="reviewsPagination" class="pagination-controls" style="display: none; text-align: center; margin-top: 1.5rem; gap: 1rem;">
                <button id="prevBtn" class="page-btn" onclick="changePage(-1)" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Previous</button>
                <span id="pageInfo" class="page-info" style="margin: 0 1rem; font-size: 0.9rem; color: #666;"></span>
                <button id="nextBtn" class="page-btn" onclick="changePage(1)" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Next</button>
            </div>
            <button id="loadMoreReviewsBtn" class="load-more-btn" style="display: none;" onclick="loadMoreReviews()">
                Load More Reviews
            </button>
        </div>
    </div>
</div>

<!-- Review Submission Modal -->
<div id="reviewModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Write a Review</h2>
            <span class="close" onclick="closeReviewForm()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="review-app-info" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <h4 id="reviewAppTitle" style="margin: 0 0 0.5rem 0;"></h4>
                <div style="color: #666; font-size: 0.9rem;">
                    <span id="reviewAppCategory"></span> ‚Ä¢
                    <span id="reviewAppRating"></span>‚òÖ
                </div>
            </div>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Your Rating:</label>
                    <div class="rating-input" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="radio" id="star5" name="rating" value="5" style="display: none;">
                        <label for="star5" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;">‚òÖ</label>
                        <input type="radio" id="star4" name="rating" value="4" style="display: none;">
                        <label for="star4" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;">‚òÖ</label>
                        <input type="radio" id="star3" name="rating" value="3" style="display: none;">
                        <label for="star3" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;">‚òÖ</label>
                        <input type="radio" id="star2" name="rating" value="2" style="display: none;">
                        <label for="star2" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;">‚òÖ</label>
                        <input type="radio" id="star1" name="rating" value="1" style="display: none;">
                        <label for="star1" style="font-size: 1.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s;">‚òÖ</label>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="reviewText" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Your Review:</label>
                    <textarea
                        id="reviewText"
                        name="review_text"
                        required
                        minlength="10"
                        rows="4"
                        placeholder="Share your experience with this app..."
                        style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit;"
                    ></textarea>
                    <small style="color: #666; font-size: 0.8rem;">Minimum 10 characters required</small>
                </div>
                <div class="form-actions" style="text-align: right; gap: 1rem; display: flex; justify-content: flex-end;">
                    <button type="button" onclick="closeReviewForm()" style="background: #6c757d; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="background: #667eea; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 6px; cursor: pointer;">Submit Review</button>
                </div>
            </form>
            <div id="reviewSubmissionMessage" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 6px;">
                <!-- Success/error message will be shown here -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    let searchTimeout;
    let currentResults = [];
    let currentPage = 1;
    let currentQuery = '';
    let currentFilters = {};
    let hasMoreResults = true;

    // Modal and review variables
    let currentApp = null;
    let reviewCurrentPage = 1;
    let reviewTotalPages = 1;
    let isAuthenticated = "{% if user.is_authenticated %}true{% else %}false{% endif %}";

    // Review pagination variables
    let reviewsCurrentPage = 1;
    let reviewsHasMore = false;

    const searchInput = document.getElementById('searchInput');
    const autocompleteDropdown = document.getElementById('autocompleteDropdown');
    const resultsSection = document.getElementById('resultsSection');
    const searchResults = document.getElementById('searchResults');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const loading = document.getElementById('loading');
    const noResults = document.getElementById('noResults');
    const resultsCount = document.getElementById('resultsCount');

    // Initialize categories
    fetchCategories();

    // Search input event listener
    searchInput.addEventListener('input', handleSearchInput);
    searchInput.addEventListener('keydown', handleSearchKeydown);
    searchInput.addEventListener('focus', showAutocomplete);

    // Filter event listeners
    document.getElementById('categoryFilter').addEventListener('change', performSearch);
    document.getElementById('ratingFilter').addEventListener('input', performSearch);
    document.getElementById('limitFilter').addEventListener('change', performSearch);

    // Load more button
    loadMoreBtn.addEventListener('click', loadMore);

    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            hideAutocomplete();
        }
    });

    function handleSearchInput(e) {
        const query = e.target.value.trim();

        // Clear previous timeout
        clearTimeout(searchTimeout);

        // Show autocomplete for queries >= 3 characters
        if (query.length >= 3) {
            searchTimeout = setTimeout(() => {
                fetchAutocomplete(query);
            }, 300);
        } else {
            hideAutocomplete();
            if (query.length === 0) {
                clearResults();
            }
        }
    }

    function handleSearchKeydown(e) {
        const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
        const highlighted = autocompleteDropdown.querySelector('.autocomplete-item.highlighted');

        if (e.key === 'Enter') {
            e.preventDefault();
            if (highlighted) {
                selectAutocompleteItem(highlighted);
            } else {
                performSearch();
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateAutocomplete(items, highlighted, 'down');
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateAutocomplete(items, highlighted, 'up');
        } else if (e.key === 'Escape') {
            hideAutocomplete();
        }
    }

    function navigateAutocomplete(items, highlighted, direction) {
        let newIndex = 0;

        if (highlighted) {
            highlighted.classList.remove('highlighted');
            const currentIndex = Array.from(items).indexOf(highlighted);
            newIndex = direction === 'down'
                ? (currentIndex + 1) % items.length
                : currentIndex === 0 ? items.length - 1 : currentIndex - 1;
        }

        if (items[newIndex]) {
            items[newIndex].classList.add('highlighted');
        }
    }

    function fetchAutocomplete(query) {
        const url = `/search/api/autocomplete/?q=${encodeURIComponent(query)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayAutocomplete(data.suggestions);
            })
            .catch(error => {
                console.error('Autocomplete error:', error);
                hideAutocomplete();
            });
    }

    function displayAutocomplete(suggestions) {
        if (suggestions.length === 0) {
            hideAutocomplete();
            return;
        }

        autocompleteDropdown.innerHTML = suggestions
            .map(app => `
                <div class="autocomplete-item" data-name="${app.name}" data-id="${app.id}">
                    <strong>${app.name}</strong>
                    <span style="color: #666; margin-left: 0.5rem;">${app.category}</span>
                    ${app.rating ? `<span style="color: #f59e0b; margin-left: 0.5rem;">‚òÖ ${app.rating}</span>` : ''}
                </div>
            `)
            .join('');

        // Add click listeners to autocomplete items
        autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', () => selectAutocompleteItem(item));
        });

        showAutocomplete();
    }

    function selectAutocompleteItem(item) {
        const name = item.dataset.name;
        searchInput.value = name;
        hideAutocomplete();
        performSearch();
    }

    function showAutocomplete() {
        autocompleteDropdown.style.display = 'block';
    }

    function hideAutocomplete() {
        autocompleteDropdown.style.display = 'none';
        autocompleteDropdown.querySelectorAll('.highlighted').forEach(item => {
            item.classList.remove('highlighted');
        });
    }

    function performSearch(resetResults = true) {
        const query = searchInput.value.trim();

        if (query.length < 3) {
            if (query.length === 0) {
                clearResults();
            }
            return;
        }

        if (resetResults) {
            currentResults = [];
            currentPage = 1;
            hasMoreResults = true;
        }

        currentQuery = query;
        currentFilters = {
            category: document.getElementById('categoryFilter').value,
            min_rating: document.getElementById('ratingFilter').value,
            limit: document.getElementById('limitFilter').value
        };

        hideAutocomplete();
        showLoading();

        const params = new URLSearchParams({
            q: query,
            limit: currentFilters.limit,
            ...currentFilters
        });

        // Remove empty parameters
        for (const [key, value] of [...params.entries()]) {
            if (!value) params.delete(key);
        }

        fetch(`/search/api/search/?${params}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();

                if (resetResults) {
                    currentResults = data.results;
                    displayResults(data.results, data.count);
                } else {
                    currentResults = [...currentResults, ...data.results];
                    appendResults(data.results);
                }

                hasMoreResults = data.results.length >= currentFilters.limit;
                updateLoadMoreButton();
            })
            .catch(error => {
                console.error('Search error:', error);
                hideLoading();
                showError('An error occurred while searching. Please try again.');
            });
    }

    function loadMore() {
        currentPage++;
        // For now, just perform the same search (API doesn't support pagination yet)
        // In a real implementation, you'd add offset/page parameters
        performSearch(false);
    }

    function displayResults(results, totalCount) {
        if (results.length === 0) {
            showNoResults();
            return;
        }

        hideNoResults();
        resultsSection.style.display = 'block';
        resultsCount.textContent = `${totalCount} result${totalCount !== 1 ? 's' : ''} found for "${currentQuery}"`;

        searchResults.innerHTML = results.map(app => createAppCard(app)).join('');

        // Add click listeners to app cards
        searchResults.querySelectorAll('.app-card').forEach(card => {
            card.addEventListener('click', () => {
                const appId = card.dataset.appId;
                openReviewsModal(appId);
            });
            card.setAttribute('data-has-listener', 'true');
        });
    }

    function appendResults(results) {
        const newCardsHTML = results.map(app => createAppCard(app)).join('');
        searchResults.insertAdjacentHTML('beforeend', newCardsHTML);

        // Add click listeners to new cards
        const newCards = searchResults.querySelectorAll('.app-card:not([data-has-listener])');
        newCards.forEach(card => {
            card.addEventListener('click', () => {
                const appId = card.dataset.appId;
                openReviewsModal(appId);
            });
            card.setAttribute('data-has-listener', 'true');
        });
    }

    function createAppCard(app) {
        const rating = app.rating ? parseFloat(app.rating).toFixed(1) : 'N/A';
        const installs = app.installs || 'Unknown';
        const similarity = (app.similarity_score * 100).toFixed(0);

        return `
            <div class="app-card" data-app-id="${app.id}">
                <div class="app-name">${app.name}</div>
                <div class="app-meta">
                    <div class="app-meta-item">
                        <span>üì±</span>
                        <span>${app.category || 'Unknown'}</span>
                    </div>
                    <div class="app-meta-item">
                        <span>‚≠ê</span>
                        <span>${rating}</span>
                    </div>
                    <div class="app-meta-item">
                        <span>üìä</span>
                        <span>${installs} installs</span>
                    </div>
                    <div class="app-meta-item">
                        <span>üí¨</span>
                        <span>${app.reviews_count || 0} reviews</span>
                    </div>
                    <div class="similarity-score">
                        ${similarity}% match
                    </div>
                </div>
            </div>
        `;
    }

    function updateLoadMoreButton() {
        if (hasMoreResults && currentResults.length >= currentFilters.limit) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    function fetchCategories() {
        fetch('/search/api/categories/')
            .then(response => response.json())
            .then(data => {
                const categorySelect = document.getElementById('categoryFilter');
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching categories:', error);
            });
    }

    function showLoading() {
        loading.style.display = 'block';
        resultsSection.style.display = 'none';
        noResults.style.display = 'none';
    }

    function hideLoading() {
        loading.style.display = 'none';
    }

    function showNoResults() {
        noResults.style.display = 'block';
        resultsSection.style.display = 'none';
    }

    function hideNoResults() {
        noResults.style.display = 'none';
    }

    function clearResults() {
        resultsSection.style.display = 'none';
        noResults.style.display = 'none';
        currentResults = [];
        currentPage = 1;
        hasMoreResults = true;
    }

    function showError(message) {
        // Simple error display - in a real app you'd have proper error UI
        alert(message);
    }

    // Modal functionality for app reviews
    let currentModalAppId = null;
    let currentReviewsPage = 1;
    let hasMoreReviews = true;

    function openReviewsModal(appId) {
        currentModalAppId = appId;
        currentReviewsPage = 1;
        reviewCurrentPage = 1;  // Initialize review pagination
        hasMoreReviews = true;

        const modal = document.getElementById('reviewsModal');
        const appDetails = document.getElementById('appDetails');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const reviewsLoading = document.getElementById('reviewsLoading');
        const noReviews = document.getElementById('noReviews');
        const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');
        const paginationDiv = document.getElementById('reviewsPagination');

        // Reset modal content
        appDetails.innerHTML = '';
        reviewsContainer.innerHTML = '';
        reviewsLoading.style.display = 'block';
        noReviews.style.display = 'none';
        loadMoreBtn.style.display = 'none';
        paginationDiv.style.display = 'none';

        // Show modal
        modal.style.display = 'block';

        // Fetch app details and reviews
        Promise.all([
            fetch(`/search/api/app/${appId}/`),
            fetch(`/search/api/app/${appId}/reviews/?page=1&limit=10`)
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([appData, reviewsData]) => {
            reviewsLoading.style.display = 'none';

            // Store current app for review form
            currentApp = appData;

            // Update Write Review button based on authentication
            const writeReviewBtn = document.getElementById('writeReviewBtn');
            if (writeReviewBtn) {
                if (isAuthenticated) {
                    writeReviewBtn.textContent = 'Write Review';
                    writeReviewBtn.onclick = openReviewForm;
                    writeReviewBtn.style.display = 'inline-block';
                } else {
                    writeReviewBtn.textContent = 'Login to Write Review';
                    writeReviewBtn.onclick = function() {
                        window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
                    };
                    writeReviewBtn.style.display = 'inline-block';
                }
            }

            // Update modal title
            document.getElementById('modalAppName').textContent = appData.name;

            // Display app details
            displayAppDetails(appData);

            // Display reviews
            if (reviewsData.reviews && reviewsData.reviews.length > 0) {
                displayReviews(reviewsData.reviews, true);

                // Update pagination variables
                reviewCurrentPage = reviewsData.pagination.page;
                reviewTotalPages = reviewsData.pagination.pages;

                // Show pagination if more than one page
                if (reviewTotalPages > 1) {
                    updateReviewsPagination();
                    paginationDiv.style.display = 'flex';
                    loadMoreBtn.style.display = 'none';  // Hide load more when using pagination
                } else {
                    // Use load more for single page or remaining items
                    hasMoreReviews = reviewsData.pagination.page < reviewsData.pagination.pages;
                    updateLoadMoreReviewsButton();
                }
            } else {
                noReviews.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching app data:', error);
            reviewsLoading.style.display = 'none';
            showError('Failed to load app details. Please try again.');
        });
    }

    function closeReviewsModal() {
        const modal = document.getElementById('reviewsModal');
        modal.style.display = 'none';
        currentModalAppId = null;
    }

    function displayAppDetails(app) {
        const appDetails = document.getElementById('appDetails');
        const rating = app.rating ? parseFloat(app.rating).toFixed(1) : 'N/A';

        appDetails.innerHTML = `
            <h3>${app.name}</h3>
            <div class="app-info-grid">
                <div class="app-info-item">
                    <div class="app-info-label">Category</div>
                    <div class="app-info-value">${app.category || 'Unknown'}</div>
                </div>
                <div class="app-info-item">
                    <div class="app-info-label">Rating</div>
                    <div class="app-info-value">‚≠ê ${rating}</div>
                </div>
                <div class="app-info-item">
                    <div class="app-info-label">Installs</div>
                    <div class="app-info-value">${app.installs || 'Unknown'}</div>
                </div>
                <div class="app-info-item">
                    <div class="app-info-label">Reviews</div>
                    <div class="app-info-value">${app.reviews_count || 0}</div>
                </div>
                <div class="app-info-item">
                    <div class="app-info-label">Type</div>
                    <div class="app-info-value">${app.app_type || 'Unknown'}</div>
                </div>
                ${app.size ? `
                <div class="app-info-item">
                    <div class="app-info-label">Size</div>
                    <div class="app-info-value">${app.size}</div>
                </div>` : ''}
            </div>
        `;
    }

    function displayReviews(reviews, clearPrevious = false) {
        const reviewsContainer = document.getElementById('reviewsContainer');

        if (clearPrevious) {
            reviewsContainer.innerHTML = '';
        }

        const reviewsHTML = reviews.map(review => createReviewItem(review)).join('');
        reviewsContainer.insertAdjacentHTML('beforeend', reviewsHTML);
    }

    function createReviewItem(review) {
        const sentimentClass = getSentimentClass(review.sentiment);
        const rating = review.rating ? '‚≠ê'.repeat(Math.round(review.rating)) : '';
        const date = review.created_at ? new Date(review.created_at).toLocaleDateString() : '';

        return `
            <div class="review-item">
                <div class="review-header">
                    <div class="review-rating">
                        ${rating} ${review.rating ? `(${review.rating})` : ''}
                    </div>
                    <div class="review-date">${date}</div>
                </div>
                <div class="review-text">${review.review_text}</div>
                <div class="review-footer">
                    <div class="review-user">
                        ${review.user ? `By: ${review.user}` : 'Anonymous'}
                    </div>
                    <div class="sentiment-badge ${sentimentClass}">
                        ${review.sentiment || 'neutral'}
                    </div>
                </div>
            </div>
        `;
    }

    function getSentimentClass(sentiment) {
        if (!sentiment) return 'sentiment-neutral';

        const sentimentLower = sentiment.toLowerCase();
        if (sentimentLower.includes('positive')) return 'sentiment-positive';
        if (sentimentLower.includes('negative')) return 'sentiment-negative';
        return 'sentiment-neutral';
    }

    function loadMoreReviews() {
        if (!currentModalAppId || !hasMoreReviews) return;

        currentReviewsPage++;
        const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');

        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Loading...';

        fetch(`/search/api/app/${currentModalAppId}/reviews/?page=${currentReviewsPage}&limit=10`)
            .then(response => response.json())
            .then(data => {
                if (data.reviews && data.reviews.length > 0) {
                    displayReviews(data.reviews, false);
                    hasMoreReviews = data.pagination.page < data.pagination.pages;
                    updateLoadMoreReviewsButton();
                } else {
                    hasMoreReviews = false;
                    loadMoreBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading more reviews:', error);
                showError('Failed to load more reviews. Please try again.');
            })
            .finally(() => {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = 'Load More Reviews';
            });
    }

    function updateLoadMoreReviewsButton() {
        const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');
        if (hasMoreReviews) {
            loadMoreBtn.style.display = 'block';
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    // Pagination functions for reviews
    function updateReviewsPagination() {
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        pageInfo.textContent = `Page ${reviewCurrentPage} of ${reviewTotalPages}`;
        prevBtn.disabled = reviewCurrentPage <= 1;
        nextBtn.disabled = reviewCurrentPage >= reviewTotalPages;
    }

    function changePage(direction) {
        if (!currentModalAppId) return;

        const newPage = reviewCurrentPage + direction;
        if (newPage >= 1 && newPage <= reviewTotalPages) {
            loadReviewsPage(currentModalAppId, newPage);
        }
    }

    function loadReviewsPage(appId, page) {
        const reviewsLoading = document.getElementById('reviewsLoading');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const paginationDiv = document.getElementById('reviewsPagination');

        reviewsLoading.style.display = 'block';
        reviewsContainer.innerHTML = '';
        paginationDiv.style.display = 'none';

        fetch(`/search/api/app/${appId}/reviews/?page=${page}&limit=10`)
            .then(response => response.json())
            .then(data => {
                reviewsLoading.style.display = 'none';

                if (data.reviews && data.reviews.length > 0) {
                    displayReviews(data.reviews, true);
                    reviewCurrentPage = data.pagination.page;
                    reviewTotalPages = data.pagination.pages;
                    updateReviewsPagination();
                    paginationDiv.style.display = 'flex';
                } else {
                    document.getElementById('noReviews').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading reviews page:', error);
                reviewsLoading.style.display = 'none';
                showError('Failed to load reviews. Please try again.');
            });
    }

    // Review form functions
    function openReviewForm() {
        if (!currentApp) return;

        // Check if user is logged in
        if (!isAuthenticated) {
            alert('Please login to write a review.');
            window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
            return;
        }

        // Update review modal with app info
        document.getElementById('reviewAppTitle').textContent = currentApp.name;
        document.getElementById('reviewAppCategory').textContent = currentApp.category || 'Unknown';
        document.getElementById('reviewAppRating').textContent = (currentApp.rating ? parseFloat(currentApp.rating).toFixed(1) : 'N/A');

        // Reset form
        document.getElementById('reviewForm').reset();
        document.getElementById('reviewSubmissionMessage').style.display = 'none';

        // Reset star ratings
        document.querySelectorAll('.rating-input label').forEach(label => {
            label.style.color = '#d1d5db';
        });

        // Show review modal
        document.getElementById('reviewModal').style.display = 'block';
    }

    function closeReviewForm() {
        document.getElementById('reviewModal').style.display = 'none';
    }

    async function submitReview(event) {
        event.preventDefault();

        if (!currentApp) return;

        const formData = new FormData(event.target);
        const rating = formData.get('rating');
        const reviewText = document.getElementById('reviewText').value.trim();

        // Validate input
        if (!rating) {
            alert('Please select a rating');
            return;
        }

        if (reviewText.length < 10) {
            alert('Review must be at least 10 characters long');
            return;
        }

        try {
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');

            const response = await fetch(`/reviews/api/app/${currentApp.id}/submit-review/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    rating: parseFloat(rating),
                    review_text: reviewText
                })
            });

            const result = await response.json();

            if (response.ok) {
                // Show success message
                const messageDiv = document.getElementById('reviewSubmissionMessage');
                messageDiv.innerHTML = `
                    <div style="color: #059669; background: #d1fae5; padding: 1rem; border-radius: 6px;">
                        <strong>Review submitted successfully!</strong><br>
                        Your review has been submitted and is pending approval by our supervisors.
                    </div>
                `;
                messageDiv.style.display = 'block';

                // Hide form
                document.getElementById('reviewForm').style.display = 'none';

                // Auto-close after 3 seconds
                setTimeout(() => {
                    closeReviewForm();
                }, 3000);

            } else {
                throw new Error(result.error || 'Failed to submit review');
            }
        } catch (error) {
            console.error('Error submitting review:', error);
            const messageDiv = document.getElementById('reviewSubmissionMessage');
            messageDiv.innerHTML = `
                <div style="color: #dc2626; background: #fef2f2; padding: 1rem; border-radius: 6px;">
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
            messageDiv.style.display = 'block';
        }
    }

    // Star rating functionality
    document.addEventListener('DOMContentLoaded', function() {
        const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
        const ratingLabels = document.querySelectorAll('.rating-input label');

        ratingLabels.forEach((label, index) => {
            label.addEventListener('click', function() {
                const value = this.getAttribute('for').replace('star', '');

                // Reset all stars
                ratingLabels.forEach(l => l.style.color = '#d1d5db');

                // Highlight selected stars (reverse order)
                for (let i = ratingLabels.length - 1; i >= ratingLabels.length - value; i--) {
                    ratingLabels[i].style.color = '#fbbf24';
                }
            });

            label.addEventListener('mouseover', function() {
                const value = this.getAttribute('for').replace('star', '');

                // Highlight on hover (reverse order)
                ratingLabels.forEach(l => l.style.color = '#d1d5db');
                for (let i = ratingLabels.length - 1; i >= ratingLabels.length - value; i--) {
                    ratingLabels[i].style.color = '#fbbf24';
                }
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const reviewsModal = document.getElementById('reviewsModal');
            const reviewModal = document.getElementById('reviewModal');

            if (event.target === reviewsModal) {
                closeReviewsModal();
            }
            if (event.target === reviewModal) {
                closeReviewForm();
            }
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('reviewsModal');
        if (event.target === modal) {
            closeReviewsModal();
        }
    });
</script>
{% endblock %}